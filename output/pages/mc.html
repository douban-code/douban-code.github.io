<!doctype html>
<html class="no-js" lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<title>Douban CODE</title>
<meta name="description" content="">
<meta name="author" content="code">

<link rel="stylesheet" href="/theme/css/foundation.css" />
<link rel="stylesheet" href="/theme/css/pygment/code.css" />
<link rel="stylesheet" href="/theme/css/custom.css" />
<link rel="stylesheet" href="/theme/css/doc.css" />


<script src="/theme/js/modernizr.js"></script>

<!-- Feeds -->


</head>
<body>
<div class="off-canvas-wrap">
    <div class="inner-wrap">
        <!-- mobile top bar to activate nav -->
        <nav class="tab-bar show-for-small">
            <section class="left-small">
                <a class="left-off-canvas-toggle menu-icon" ><span></span></a>
            </section>

            <section class="middle tab-bar-section">
                <h1 class="title">Douban&nbsp;CODE</h1>
            </section>
        </nav>

        <!-- mobile side bar nav -->
        <aside class="left-off-canvas-menu">
            <ul class="off-canvas-list">
                <li><a href="">Home</a></li>
                <li><label>Categories</label></li>

                <li><label>Places</label></li>
                <li><a href="/pages/code.html">CODE</a></li>
                <li><a href="/pages/sqlstore.html">SQLStore</a></li>
                <li><a href="/pages/mc.html">MC</a></li>
                <li><a href="/pages/quixote.html">Quixote</a></li>
                <li><a href="/pages/ellen.html">Ellen</a></li>
                <li><a href="/pages/pygit2.html">Pygit2</a></li>
                <li><a href="/pages/gpack.html">GPack</a></li>
                <li><a href="/pages/linguist.html">Linguist</a></li>
                <li><a href="/pages/scanner.html">Scanner</a></li>
                <li><a href="/pages/mikoto.html">Mikoto</a></li>
                <li><a href="/pages/misaka.html">Misaka</a></li>
                <li><a href="/pages/about.html">About</a></li>



                <li><label>Links</label></li>
                <li><a href="https://github.com/douban-code">CODE@GitHub</a></li>
                <li><a href="https://github.com/douban">Douban@GitHub</a></li>
            </ul>
        </aside>

        <!-- Main Page Content and Sidebar -->
            <div class="row">
                <!-- Sidebar -->
                <div class="large-3 medium-4 columns sidebar">
                    <div class="hide-for-small">
                        <p class="text-center">
                            <a href="/"><img src="/images/logo.svg" width="80px"></a>
                        </p>
                        <ul class="side-nav">
                            <li><a href="/">Home</a></li>
                            <li class="divider"></li>
                            <li><a href="/pages/code.html">CODE</a></li>
                            <li><a href="/pages/sqlstore.html">SQLStore</a></li>
                            <li><a href="/pages/mc.html">MC</a></li>
                            <li><a href="/pages/quixote.html">Quixote</a></li>
                            <li><a href="/pages/ellen.html">Ellen</a></li>
                            <li><a href="/pages/pygit2.html">Pygit2</a></li>
                            <li><a href="/pages/gpack.html">GPack</a></li>
                            <li><a href="/pages/linguist.html">Linguist</a></li>
                            <li><a href="/pages/scanner.html">Scanner</a></li>
                            <li><a href="/pages/mikoto.html">Mikoto</a></li>
                            <li><a href="/pages/misaka.html">Misaka</a></li>
                            <li><a href="/pages/about.html">About</a></li>
                            <li class="divider"></li>
                            <li><a href="/blog.html">Blog</a></li>
                            <li class="divider"></li>
                            <li><a href="https://github.com/douban-code">CODE@GitHub</a></li>
                            <li><a href="https://github.com/douban">Douban@GitHub</a></li>
                            <li class="divider"></li>
                            <li><a href="/blog.html">Contributing</a></li>
                            <li class="divider"></li>
                            <li class="heading">Tag</li>
                        </ul>
                    </div>
                </div>
                <!-- End Sidebar -->
                <!-- Main Content -->
                <div class="large-9 medium-8 columns">
                    <div class="row">
                        <div class="small-12 columns">
                            <h1>MC</h1>
                        </div>
                    </div>
<div class="row">
	<div class="small-12 columns">
		<hr />
<h2>Memcached 缓存接口</h2>
<h3>简介</h3>
<p>缓存是优化系统性能的工具。豆瓣使用 <a href="http://memcached.org/">Memcached</a> 作为缓存系统，通过一个单
实例的变量作为该系统的访问接口。</p>
<h3>访问方法</h3>
<p>mc 是类 cmemcached.Client 的单实例对象。在调用它的模块中，要这样引用它</p>
<div class="highlight"><pre><span class="n">from</span> <span class="n">code</span><span class="p">.</span><span class="n">libs</span><span class="p">.</span><span class="n">store</span> <span class="n">import</span> <span class="n">mc</span>
</pre></div>


<h3>API</h3>
<p>Memcached 的接口非常简单。它是一个键值对（key-value pair）存储系统，最常用的是设置、获取和删除操作。</p>
<h4>set：设置</h4>
<p>在 Memcached 中，添加操作与修改操作相同。要设置一个值，可以调用：</p>
<div class="highlight"><pre><span class="n">key</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">user_number</span><span class="err">&#39;</span>
<span class="n">value</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">mc</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</pre></div>


<p>这个缓存设置之后，会一直存在，直到被删除，或者存储不够用，被新的内容从内存中挤出去。如果要让内容自动过期，可以：</p>
<div class="highlight"><pre><span class="n">USER_NUMBER_EXPIRES</span> <span class="o">=</span> <span class="mi">3600</span>
<span class="n">mc</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">USER_NUMBER_EXPIRES</span><span class="p">)</span>
</pre></div>


<p>通过第三个参数掺入过期时间，以秒为单位。</p>
<h4>get，get_multi：获取</h4>
<p>随时可以从缓存中重新获得放入的数据：</p>
<div class="highlight"><pre><span class="n">value</span> <span class="o">=</span> <span class="n">mc</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</pre></div>


<p>如果这个 key 在缓存中不存在，或者已经过期，get 方法将返回 None。</p>
<p>还可以一次获取多个键值的内容，提高访问效率：</p>
<div class="highlight"><pre><span class="n">values</span> <span class="o">=</span> <span class="n">mc</span><span class="p">.</span><span class="n">get_multi</span><span class="p">([</span><span class="n">key1</span><span class="p">,</span> <span class="n">key2</span><span class="p">,</span> <span class="n">key3</span><span class="p">])</span>
</pre></div>


<h4>delete：删除</h4>
<p>删除操作会把缓存中的指定键值立即过期：</p>
<div class="highlight"><pre><span class="n">mc</span><span class="p">.</span><span class="n">delete</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</pre></div>


<h4>incr，decr：自增，自减</h4>
<p>如果保存值是整形，还可以通过 incr 和 decr 对数据直接增加或减少：</p>
<div class="highlight"><pre><span class="n">mc</span><span class="p">.</span><span class="n">incr</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="n">mc</span><span class="p">.</span><span class="n">decr</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</pre></div>


<p>默认自增或自减1。也可以制定要增减的量：</p>
<div class="highlight"><pre><span class="n">mc</span><span class="p">.</span><span class="n">incr</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</pre></div>


<h3>缓存原则</h3>
<p>首先，必须要认识到：缓存是对性能做优化的手段，而不是开发的目的。在开发过程中，
缓存应该是最后被引入的内容。代码不应该依赖于缓存，没有缓存支持，代码也应该可以正常运行。</p>
<p>另外，基于数据更新的考虑，对于放入缓存的内容，我们有以下原则：</p>
<ol>
<li>类的实例化对象，应该单独缓存，每个 key 只缓存一个对象</li>
<li>禁止缓存类的实例化对象的列表</li>
<li>缓存的值是列表时，列表中的每个值应该是简单类型，比如对象的id</li>
</ol>
<p>这个原则的目的是为了避免这种情况：</p>
<blockquote>
<p>假设，类 User 的实例 user1，同时存在于 1000 个用户的关注列表中。当 user1 修改了自己的网名时， 我们需要把 1000 个用户的关注列表全部过期，否则 user1 在这些用户的列表中的网名永远都不能正确显示。</p>
</blockquote>
<p>这样存储对象的列表的大量过期，会带来很严重的问题：</p>
<ul>
<li>缓存过期频繁，缓存命中率过低</li>
<li>难以维护对象与相关列表的对应关系，甚至无法找到所有缓存该对象的相关列表，执行过期操作</li>
</ul>
<p>对应这个例子，豆瓣实际采用的缓存策略是：</p>
<p>user1 只在一个 key（u:user1_id）中缓存，其他所有相关的列表，都只存储 user_id。</p>
<p>这样在任何需要使用 user1 的地方，都可以从 u:user1_id 这个缓存中得到 user1 的最新信息，从而避免了缓存不一致的问题。</p>
<h3>命名规则</h3>
<p>mc 命名规范基本为：</p>
<div class="highlight"><pre><span class="err">功能名称</span><span class="o">:</span><span class="n">id</span>
<span class="err">功能名称</span><span class="o">:</span><span class="n">id</span><span class="o">:</span><span class="n">id2</span><span class="o">:</span><span class="n">id3</span>
</pre></div>


<p>例如：</p>
<div class="highlight"><pre><span class="n">minisite</span><span class="o">:</span><span class="n">converse</span>
<span class="n">page_by_name</span><span class="o">:</span><span class="n">pk14</span><span class="o">:</span><span class="mi">2002</span>
</pre></div>


<p>在命名中，冒号「:」用来分割功能名称及各id，下划线「 _ 」用来在功能名称中代替空格。</p>
<p>注意：
缓存中key的名字必须是字符串类型，并且不允许包含空格：chr(32)以及小于chr(32)的任何控制字符。utf-8字符是允许的。
常见的错误，就是把用户输入的内容未经过滤，直接作为cache key的一部分；需要大家根据自己的应用，生成key时做过滤、变换、转义等必须的处理。</p>
<h3>应用实例</h3>
<h4>取内容</h4>
<p>下面是取一个相册图片示例的方法（代码已经过改造），典型的取一个对象的例子：</p>
<div class="highlight"><pre> <span class="n">def</span> <span class="n">get_photo</span><span class="p">(</span><span class="n">photo_id</span><span class="p">)</span><span class="o">:</span>
     <span class="n">key</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">photo</span><span class="o">:%</span><span class="n">s</span><span class="err">&#39;</span> <span class="o">%</span> <span class="n">photo_id</span>
     <span class="n">photo</span> <span class="o">=</span> <span class="n">mc</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
     <span class="k">if</span> <span class="n">photo</span> <span class="n">is</span> <span class="n">None</span><span class="o">:</span>
         <span class="n">cursor</span> <span class="o">=</span> <span class="n">store</span><span class="p">.</span><span class="n">get_cursor</span><span class="p">(</span><span class="n">table</span><span class="o">=</span><span class="err">&#39;</span><span class="n">photo</span><span class="err">&#39;</span><span class="p">)</span>
         <span class="n">cursor</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="err">&#39;</span><span class="n">select</span> <span class="n">id</span><span class="p">,</span> <span class="n">creator_id</span><span class="p">,</span> <span class="n">album_id</span><span class="p">,</span> <span class="n">create_time</span><span class="p">,</span> <span class="err">&#39;</span>
                        <span class="err">&#39;</span><span class="n">n_comments</span><span class="p">,</span> <span class="n">properties</span><span class="p">,</span> <span class="n">privacy</span> <span class="err">&#39;</span>
                        <span class="err">&#39;</span><span class="n">from</span> <span class="n">photo</span> <span class="n">where</span> <span class="n">id</span><span class="o">=%</span><span class="n">s</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">photo_id</span><span class="p">)</span>
         <span class="n">row</span> <span class="o">=</span> <span class="n">cursor</span><span class="p">.</span><span class="n">fetchone</span><span class="p">()</span>
         <span class="k">if</span> <span class="n">row</span><span class="o">:</span>
             <span class="n">photo</span> <span class="o">=</span> <span class="n">Photo</span><span class="p">(</span><span class="o">*</span><span class="n">row</span><span class="p">)</span>
             <span class="n">mc</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">photo</span><span class="p">)</span>
     <span class="k">return</span> <span class="n">photo</span>
</pre></div>


<p>下面是取一个列表中所有图片的方法，典型的取一个列表的例子：</p>
<div class="highlight"><pre> <span class="n">def</span> <span class="n">get_photos</span><span class="p">(</span><span class="n">photo_ids</span><span class="p">)</span><span class="o">:</span>
     <span class="n">ps</span> <span class="o">=</span> <span class="n">mc</span><span class="p">.</span><span class="n">get_multi</span><span class="p">([</span><span class="err">&#39;</span><span class="n">photo</span><span class="o">:%</span><span class="n">s</span><span class="err">&#39;</span> <span class="o">%</span> <span class="n">id</span> <span class="k">for</span> <span class="n">id</span> <span class="n">in</span> <span class="n">photo_ids</span><span class="p">])</span>
     <span class="n">all_photos</span> <span class="o">=</span> <span class="p">[</span><span class="n">id</span> <span class="n">and</span> <span class="n">ps</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="err">&#39;</span><span class="n">photo</span><span class="o">:%</span><span class="n">s</span><span class="err">&#39;</span> <span class="o">%</span> <span class="n">id</span><span class="p">)</span> <span class="n">or</span> <span class="n">get_photo</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
                   <span class="k">for</span> <span class="n">id</span> <span class="n">in</span> <span class="n">photo_ids</span><span class="p">]</span>
     <span class="k">return</span> <span class="n">all_photos</span>
</pre></div>


<p>请通过上面两个例子，重新回顾「缓存原则」。</p>
<h4>用装饰符cache简化编程</h4>
<p>用 <code>code/libs/store.py</code> 中的 decorator 可以简化取单个对象的例子：</p>
<div class="highlight"><pre> <span class="n">from</span> <span class="n">code</span><span class="p">.</span><span class="n">libs</span><span class="p">.</span><span class="n">store</span> <span class="n">import</span> <span class="n">cache</span>

 <span class="err">@</span><span class="n">cache</span><span class="p">(</span><span class="err">&#39;</span><span class="n">photo</span><span class="o">:</span><span class="p">{</span><span class="n">photo_id</span><span class="p">}</span><span class="err">&#39;</span><span class="p">)</span>
 <span class="n">def</span> <span class="n">get_photo</span><span class="p">(</span><span class="n">photo_id</span><span class="p">)</span><span class="o">:</span>
     <span class="n">cursor</span> <span class="o">=</span> <span class="n">store</span><span class="p">.</span><span class="n">get_cursor</span><span class="p">(</span><span class="n">table</span><span class="o">=</span><span class="err">&#39;</span><span class="n">photo</span><span class="err">&#39;</span><span class="p">)</span>
     <span class="n">cursor</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="err">&#39;</span><span class="n">select</span> <span class="n">id</span><span class="p">,</span> <span class="n">creator_id</span><span class="p">,</span> <span class="n">album_id</span><span class="p">,</span> <span class="n">create_time</span><span class="p">,</span> <span class="err">&#39;</span>
                    <span class="err">&#39;</span><span class="n">n_comments</span><span class="p">,</span> <span class="n">properties</span><span class="p">,</span> <span class="n">privacy</span> <span class="err">&#39;</span>
                    <span class="err">&#39;</span><span class="n">from</span> <span class="n">photo</span> <span class="n">where</span> <span class="n">id</span><span class="o">=%</span><span class="n">s</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">photo_id</span><span class="p">)</span>
     <span class="n">row</span> <span class="o">=</span> <span class="n">cursor</span><span class="p">.</span><span class="n">fetchone</span><span class="p">()</span>
     <span class="k">if</span> <span class="n">row</span><span class="o">:</span>
            <span class="k">return</span> <span class="n">Photo</span><span class="p">(</span><span class="o">*</span><span class="n">row</span><span class="p">)</span>
</pre></div>


<p>这样，开发时只针对数据库编程，在代码完成后针对适当的函数添加 cache 装饰符，
即可完成性能优化的工作。</p>
<h4>用装饰符pcache简化编程</h4>
<p><code>code/libs/store.py</code> 中还有另外一个用于缓存系统的装饰符 pcache。它可以帮助对带有 limit 参数的函数增加缓存支持，
一般这些函数对应于网站上的翻页功能：pcache 只缓存其中「第一页」内容。</p>
<p>下面是一个例子：</p>
<div class="highlight"><pre> <span class="err">@</span><span class="n">pcache</span><span class="p">(</span><span class="err">&#39;</span><span class="n">random_group</span><span class="err">&#39;</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">3600</span><span class="p">)</span>
 <span class="n">def</span> <span class="n">random_groups</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span><span class="o">:</span>
     <span class="n">cursor</span> <span class="o">=</span> <span class="n">store</span><span class="p">.</span><span class="n">get_cursor</span><span class="p">(</span><span class="n">table</span><span class="o">=</span><span class="err">&#39;</span><span class="mi">15</span><span class="n">_minute_group</span><span class="err">&#39;</span><span class="p">)</span>
     <span class="n">cursor</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="err">&#39;</span><span class="n">select</span> <span class="n">gids</span> <span class="n">from</span> <span class="err">`</span><span class="mi">15</span><span class="n">_minute_group</span><span class="err">`&#39;</span><span class="p">)</span>
     <span class="n">row</span> <span class="o">=</span> <span class="n">cursor</span><span class="p">.</span><span class="n">fetchone</span><span class="p">()</span>
     <span class="k">if</span> <span class="n">row</span> <span class="n">and</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">:</span>
         <span class="k">return</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="sc">&#39;|&#39;</span><span class="p">)[</span><span class="o">:</span><span class="n">limit</span><span class="p">]</span>
     <span class="nl">else:</span>
         <span class="k">return</span> <span class="p">[]</span>
</pre></div>


<p>这里只缓存 limit 为 300 时的返回值。如果有请求的 limit 不超过 300，则直接从缓存中的内容返回数据。</p>
	</div>
</div>
                </div>
                <!-- End Main Content -->
            </div>

            <!-- Footer -->
            <footer class="row">
                    <p>CODE © Douban Inc. 2012-2014</p>
            </footer>
            <!-- End Footer -->
        <a class="exit-off-canvas"></a>
    </div><!--off-canvas inner-->
</div><!--off-canvas wrap-->

<script src="/theme/js/jquery.js"></script>
<script src="/theme/js/foundation.min.js"></script>
<script>
    $(document).foundation();
</script>
</body>
</html>